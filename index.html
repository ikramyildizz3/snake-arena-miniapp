<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Snake Arena – Classic+</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #141b25 0, #05070b 55%, #020308 100%);
      color: #e9f1ff;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .app-shell {
      width: 100%;
      max-width: 900px;
      padding: 10px 10px 14px;
    }

    .top-row {
      display: flex;
      gap: 10px;
      align-items: stretch;
    }

    .hud-card {
      flex: 1.1;
      background: rgba(6, 12, 18, 0.95);
      border-radius: 14px;
      border: 1px solid rgba(124, 255, 151, 0.4);
      padding: 8px 10px;
      display: grid;
      grid-template-columns: repeat(6, minmax(0, 1fr));
      gap: 4px;
      font-size: 11px;
    }

    .hud-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 2px 3px;
      border-radius: 8px;
      background: radial-gradient(circle at top, rgba(22, 40, 30, 0.9), rgba(5, 10, 8, 0.9));
    }

    .hud-label {
      font-size: 9px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      opacity: 0.7;
    }

    .hud-value {
      font-weight: 700;
      font-size: 14px;
    }

    .mode-pill {
      justify-self: flex-end;
      align-self: center;
      padding: 4px 9px;
      border-radius: 999px;
      border: 1px solid rgba(255, 255, 255, 0.12);
      background: linear-gradient(135deg, #0d1419, #111b24);
      font-size: 10px;
      text-align: center;
      min-width: 70px;
    }

    .mode-pill span {
      display: block;
      font-size: 8px;
      text-transform: uppercase;
      opacity: 0.7;
    }

    .game-frame-wrapper {
      flex: 1.2;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .game-frame {
      position: relative;
      background: radial-gradient(circle at top, #07100b 0, #020503 55%, #000000 100%);
      border-radius: 18px;
      padding: 10px;
      border: 2px solid rgba(124, 255, 151, 0.5);
      box-shadow: 0 0 0 1px rgba(0, 0, 0, 0.8), 0 18px 40px rgba(0, 0, 0, 0.8);
      width: 100%;
      max-width: 520px;
      aspect-ratio: 1 / 1;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }

    canvas {
      width: 100%;
      height: 100%;
      image-rendering: pixelated;
      display: block;
    }

    .bottom-row {
      margin-top: 10px;
      display: flex;
      gap: 10px;
      align-items: stretch;
    }

    .help-card {
      flex: 1.1;
      background: rgba(8, 11, 16, 0.96);
      border-radius: 14px;
      border: 1px solid rgba(255, 255, 255, 0.08);
      padding: 8px 10px;
      font-size: 11px;
      line-height: 1.45;
    }

    .help-card strong {
      color: #7cff97;
    }

    .desktop-actions {
      flex: 1;
      display: flex;
      justify-content: flex-end;
      align-items: center;
      gap: 10px;
    }

    .pill-btn {
      border-radius: 999px;
      border: 1px solid rgba(124, 255, 151, 0.35);
      background: radial-gradient(circle at top, #0e1d14, #030806);
      color: #e9f1ff;
      font-size: 11px;
      padding: 7px 14px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      user-select: none;
      white-space: nowrap;
    }

    .pill-btn span.small {
      font-size: 9px;
      opacity: 0.7;
    }

    .pill-btn:active {
      transform: translateY(1px) scale(0.98);
    }

    .pill-btn.dim {
      opacity: 0.4;
      border-style: dashed;
      cursor: default;
    }

    /* Mobile controls */
    .mobile-controls {
      margin-top: 12px;
      display: none;
      gap: 16px;
      align-items: center;
      justify-content: space-between;
    }

    .dpad {
      width: 140px;
      height: 140px;
      position: relative;
      display: grid;
      place-items: center;
    }

    .dpad-btn {
      position: absolute;
      width: 54px;
      height: 54px;
      border-radius: 18px;
      border: 1px solid rgba(124, 255, 151, 0.4);
      background: radial-gradient(circle at top, #111b16, #050806);
      color: #e9f1ff;
      font-size: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      user-select: none;
    }

    .dpad-btn:active {
      transform: translateY(1px) scale(0.95);
    }

    .dpad-btn.up { top: 0; left: 50%; transform: translate(-50%, 0); }
    .dpad-btn.down { bottom: 0; left: 50%; transform: translate(-50%, 0); }
    .dpad-btn.left { left: 0; top: 50%; transform: translate(0, -50%); }
    .dpad-btn.right { right: 0; top: 50%; transform: translate(0, -50%); }

    .dpad-center {
      width: 60px;
      height: 60px;
      border-radius: 20px;
      border: 1px solid rgba(124, 255, 151, 0.35);
      background: radial-gradient(circle at top, #0e1b14, #020403);
      opacity: 0.8;
    }

    .mobile-actions {
      flex: 1;
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }

    .mobile-main-btn {
      flex: 1;
      min-width: 0;
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid rgba(124, 255, 151, 0.4);
      background: radial-gradient(circle at top, #0e1b14, #050609);
      color: #e9f1ff;
      font-size: 12px;
      font-weight: 600;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 2px;
      user-select: none;
    }

    .mobile-main-btn span.small {
      font-size: 9px;
      opacity: 0.7;
    }

    .mobile-main-btn:active {
      transform: translateY(1px) scale(0.97);
    }

    .mobile-main-btn.dim { opacity: 0.4; border-style: dashed; }

    .badge-echo {
      color: #7cd3ff;
      font-size: 10px;
    }

    .badge-paused {
      color: #ffb86b;
      font-size: 10px;
    }

    .toast {
      position: fixed;
      left: 50%;
      bottom: 18px;
      transform: translateX(-50%);
      padding: 6px 12px;
      border-radius: 999px;
      background: rgba(0, 0, 0, 0.85);
      color: #e9f1ff;
      font-size: 11px;
      border: 1px solid rgba(255, 255, 255, 0.15);
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.25s ease;
      z-index: 40;
    }

    .toast.visible { opacity: 1; }

    @media (max-width: 780px) {
      .top-row {
        flex-direction: column;
      }

      .bottom-row {
        flex-direction: column;
      }

      .desktop-actions {
        justify-content: space-between;
      }

      .mobile-controls {
        display: flex;
      }
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <div class="top-row">
      <div class="hud-card">
        <div class="hud-item">
          <div class="hud-label">Skor</div>
          <div class="hud-value" id="hud-score">0</div>
        </div>
        <div class="hud-item">
          <div class="hud-label">Best</div>
          <div class="hud-value" id="hud-best">0</div>
        </div>
        <div class="hud-item">
          <div class="hud-label">Uzunluk</div>
          <div class="hud-value" id="hud-length">5</div>
        </div>
        <div class="hud-item">
          <div class="hud-label">Hız</div>
          <div class="hud-value" id="hud-speed">x1.0</div>
        </div>
        <div class="hud-item">
          <div class="hud-label">Echo</div>
          <div class="hud-value" id="hud-echo">3</div>
        </div>
        <div class="hud-item">
          <div class="hud-label">Can</div>
          <div class="hud-value" id="hud-lives">3</div>
        </div>
        <div class="hud-item">
          <div class="hud-label">Bölüm</div>
          <div class="hud-value" id="hud-level">1</div>
        </div>
        <div class="mode-pill">
          CASUAL
          <span>yavaş + öğrenme modu</span>
        </div>
      </div>

      <div class="game-frame-wrapper">
        <div class="game-frame">
          <canvas id="game"></canvas>
        </div>
      </div>
    </div>

    <div class="bottom-row">
      <div class="help-card">
        <strong>Kontroller</strong><br />
        PC: Yön için WASD veya ok tuşları · <strong>Space</strong> = Echo (geri sar) · <strong>P</strong> = Dur / devam.<br />
        Mobil: Aşağıdaki yön tuşlarını kullan · ECHO ve DUR butonları sağda.
        <br /><br />
        Echo: son birkaç hamleyi kaydedip seni geriye alır, zor durumdan kurtarır. Mavi orb yersen Echo +1 (maks. 3).<br />
        Bölüm atlamak için yeterince yem topla; her bölümde duvar düzeni zorlaşır.
      </div>

      <div class="desktop-actions">
        <button class="pill-btn" id="btn-echo-desktop">
          ECHO
          <span class="small">Space</span>
        </button>
        <button class="pill-btn" id="btn-pause-desktop">
          DUR
          <span class="small">P</span>
        </button>
      </div>
    </div>

    <div class="mobile-controls">
      <div class="dpad">
        <div class="dpad-center"></div>
        <button class="dpad-btn up" data-dir="up">▲</button>
        <button class="dpad-btn down" data-dir="down">▼</button>
        <button class="dpad-btn left" data-dir="left">◀</button>
        <button class="dpad-btn right" data-dir="right">▶</button>
      </div>
      <div class="mobile-actions">
        <button class="mobile-main-btn" id="btn-echo-mobile">
          ECHO
          <span class="badge-echo" id="badge-echo-mobile">3 hak</span>
          <span class="small">geri sar</span>
        </button>
        <button class="mobile-main-btn" id="btn-pause-mobile">
          DUR
          <span class="badge-paused" id="badge-pause-mobile">oyunda</span>
          <span class="small">duraklat</span>
        </button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    // ----- Canvas ve grid ayarları -----
    const canvas = document.getElementById("game");
    const ctx = canvas.getContext("2d");

    const GRID_COLS = 30;
    const GRID_ROWS = 30;
    let cellSize = 16; // hesaplanacak

    function resizeCanvas() {
      const frame = canvas.parentElement.getBoundingClientRect();
      const size = Math.min(frame.width, frame.height);
      const dpr = window.devicePixelRatio || 1;
      canvas.width = size * dpr;
      canvas.height = size * dpr;
      ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
      cellSize = size / GRID_COLS;
      draw();
    }

    window.addEventListener("resize", resizeCanvas);

    // ----- HUD helper -----
    const hudScore = document.getElementById("hud-score");
    const hudBest = document.getElementById("hud-best");
    const hudLength = document.getElementById("hud-length");
    const hudSpeed = document.getElementById("hud-speed");
    const hudEcho = document.getElementById("hud-echo");
    const hudLives = document.getElementById("hud-lives");
    const hudLevel = document.getElementById("hud-level");

    const echoBadgeMobile = document.getElementById("badge-echo-mobile");
    const pauseBadgeMobile = document.getElementById("badge-pause-mobile");

    const toastEl = document.getElementById("toast");
    let toastTimeout = null;

    function showToast(text) {
      toastEl.textContent = text;
      toastEl.classList.add("visible");
      if (toastTimeout) clearTimeout(toastTimeout);
      toastTimeout = setTimeout(() => toastEl.classList.remove("visible"), 1700);
    }

    // ----- Oyun state'i -----
    let score = 0;
    let bestScore = 0;
    let lives = 3;
    let levelIndex = 0; // 0 tabanlı

    const SPEEDS = [140, 115, 95, 80]; // ms per step
    let tickInterval = SPEEDS[0];
    let lastTickTime = 0;
    let isPaused = false;
    let gameOver = false;

    const directions = {
      up: { x: 0, y: -1 },
      down: { x: 0, y: 1 },
      left: { x: -1, y: 0 },
      right: { x: 1, y: 0 },
    };

    let currentDir = directions.right;
    let nextDir = directions.right;

    let snake = [];
    let snakeHistory = []; // echo için pozisyon kayıtları
    const MAX_HISTORY = 40;

    let food = null;
    let echoOrb = null;

    let echoCharges = 3;

    const LEVELS = [
      {
        name: "Bölüm 1",
        walls: [],
        neededFood: 6,
      },
      {
        name: "Bölüm 2",
        walls: generateRingWalls(4),
        neededFood: 7,
      },
      {
        name: "Bölüm 3",
        walls: generateCrossWalls(),
        neededFood: 8,
      },
      {
        name: "Bölüm 4",
        walls: generateMazeWalls(),
        neededFood: 9,
      },
    ];

    let foodEatenThisLevel = 0;

    function generateRingWalls(padding) {
      const tiles = [];
      const minX = padding;
      const maxX = GRID_COLS - padding - 1;
      const minY = padding;
      const maxY = GRID_ROWS - padding - 1;
      for (let x = minX; x <= maxX; x++) {
        tiles.push({ x, y: minY });
        tiles.push({ x, y: maxY });
      }
      for (let y = minY; y <= maxY; y++) {
        tiles.push({ x: minX, y });
        tiles.push({ x: maxX, y });
      }
      return tiles;
    }

    function generateCrossWalls() {
      const tiles = [];
      const cx = Math.floor(GRID_COLS / 2);
      const cy = Math.floor(GRID_ROWS / 2);
      for (let x = 4; x < GRID_COLS - 4; x++) {
        if (Math.abs(x - cx) < 3) continue;
        tiles.push({ x, y: cy });
      }
      for (let y = 4; y < GRID_ROWS - 4; y++) {
        if (Math.abs(y - cy) < 3) continue;
        tiles.push({ x: cx, y });
      }
      return tiles;
    }

    function generateMazeWalls() {
      const tiles = [];
      for (let x = 3; x < GRID_COLS - 3; x++) {
        if (x % 2 === 0) tiles.push({ x, y: 6 });
        if (x % 3 === 0) tiles.push({ x, y: GRID_ROWS - 7 });
      }
      for (let y = 8; y < GRID_ROWS - 8; y++) {
        if (y % 2 === 1) tiles.push({ x: 6, y });
        if (y % 3 === 1) tiles.push({ x: GRID_COLS - 7, y });
      }
      return tiles;
    }

    function resetSnake(centerOnly = false) {
      const cx = Math.floor(GRID_COLS / 2);
      const cy = Math.floor(GRID_ROWS / 2);
      snake = [];
      for (let i = 0; i < 5; i++) {
        snake.unshift({ x: cx - i, y: cy });
      }
      currentDir = directions.right;
      nextDir = directions.right;
      snakeHistory = [];
      if (!centerOnly) {
        foodEatenThisLevel = 0;
      }
    }

    function placeRandomTile(avoid = []) {
      while (true) {
        const x = Math.floor(Math.random() * GRID_COLS);
        const y = Math.floor(Math.random() * GRID_ROWS);
        const collides = avoid.some((p) => p.x === x && p.y === y);
        if (!collides) return { x, y };
      }
    }

    function spawnFood() {
      const walls = LEVELS[levelIndex].walls;
      const avoid = [...snake, ...walls];
      food = placeRandomTile(avoid);
      // %20 ihtimalle echo orb spawnla ama çakışmasın
      if (Math.random() < 0.2) {
        echoOrb = placeRandomTile([...avoid, food]);
      } else {
        echoOrb = null;
      }
    }

    function startGame() {
      score = 0;
      lives = 3;
      levelIndex = 0;
      tickInterval = SPEEDS[0];
      gameOver = false;
      isPaused = false;
      echoCharges = 3;
      foodEatenThisLevel = 0;
      resetSnake();
      spawnFood();
      updateHud();
      lastTickTime = performance.now();
      requestAnimationFrame(loop);
      showToast("Hazırsın – iyi oyunlar!");
    }

    function loseLife() {
      lives--;
      if (lives <= 0) {
        gameOver = true;
        lives = 0;
        updateHud();
        showToast("Game over – R ile yeniden başla");
        return;
      }
      resetSnake(true);
      spawnFood();
      updateHud();
      showToast(`Çarpıştın! Kalan can: ${lives}`);
    }

    function nextLevel() {
      if (levelIndex < LEVELS.length - 1) {
        levelIndex++;
        tickInterval = SPEEDS[Math.min(levelIndex, SPEEDS.length - 1)];
        resetSnake();
        spawnFood();
        showToast(`Bölüm ${levelIndex + 1}! Duvarlar değişti`);
      } else {
        resetSnake();
        spawnFood();
        showToast("Arena ustası! Aynı bölümde devam");
      }
      updateHud();
    }

    function updateHud() {
      hudScore.textContent = score;
      hudBest.textContent = bestScore;
      hudLength.textContent = snake.length;
      const speedMult = (SPEEDS[0] / tickInterval).toFixed(1);
      hudSpeed.textContent = `x${speedMult}`;
      hudEcho.textContent = echoCharges;
      hudLives.textContent = lives;
      hudLevel.textContent = levelIndex + 1;

      if (echoBadgeMobile) {
        echoBadgeMobile.textContent = `${echoCharges} hak`;
      }
      if (pauseBadgeMobile) {
        pauseBadgeMobile.textContent = isPaused ? "duraklatıldı" : "oyunda";
      }
    }

    function changeDirection(dirKey) {
      if (gameOver) return;
      const dir = directions[dirKey];
      if (!dir) return;
      // ters yöne dönüşü engelle
      if (dir.x === -currentDir.x && dir.y === -currentDir.y) return;
      nextDir = dir;
    }

    function handleEcho() {
      if (gameOver) return;
      if (echoCharges <= 0) {
        showToast("Echo hakkın yok");
        return;
      }
      if (snakeHistory.length < 10) {
        showToast("Echo için yeterli kayıt yok");
        return;
      }
      const snapshot = snakeHistory[Math.max(0, snakeHistory.length - 15)];
      snake = snapshot.snake.map((p) => ({ x: p.x, y: p.y }));
      currentDir = { ...snapshot.dir };
      nextDir = { ...snapshot.dir };
      echoCharges--;
      updateHud();
      showToast("Echo! Zamanı geri sardın");
    }

    function togglePause() {
      if (gameOver) return;
      isPaused = !isPaused;
      if (pauseBadgeMobile) {
        pauseBadgeMobile.textContent = isPaused ? "duraklatıldı" : "oyunda";
      }
      showToast(isPaused ? "Oyun durduruldu" : "Devam");
    }

    function step() {
      if (gameOver || isPaused) return;

      // history kaydet
      snakeHistory.push({
        snake: snake.map((p) => ({ x: p.x, y: p.y })),


::contentReference[oaicite:0]{index=0}
